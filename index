<<<<<========= Index Pertama ========>>>>

<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sistem Inventaris SMA IT AL GHIFARI</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    :root { --primary: #0f172a; --gold: #d4af37; --gold-hover: #b4942b; --bg: #f8fafc; }
    body { background-color: var(--bg); font-family: 'Poppins', sans-serif; color: #334155; padding-bottom: 60px; }
    
    .hero { background: linear-gradient(135deg, var(--primary) 0%, #334155 100%); color: white; padding: 2.5rem 1rem 3.5rem; border-radius: 0 0 30px 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: -40px; transition: all 0.3s; }
    
    .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 1.5rem; margin-bottom: 1.5rem; }
    
    .menu-btn { cursor: pointer; transition: all 0.3s; text-align: center; padding: 2rem 1rem; height: 100%; }
    .menu-btn:active { transform: scale(0.95); }
    
    .icon-box { font-size: 2.5rem; margin-bottom: 1rem; background: -webkit-linear-gradient(45deg, var(--primary), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .btn-gold { background: linear-gradient(45deg, var(--gold), #eab308); color: white; border: none; border-radius: 50px; padding: 10px 25px; font-weight: 600; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
    .btn-gold:hover { background: var(--gold-hover); color: white; }
    
    .hidden { display: none !important; }
    .form-control, .form-select { border-radius: 10px; padding: 10px; }
    .form-control:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(212,175,55,0.1); }
    
    /* SCANNER FULL WIDTH */
    #qr-reader { width: 100%; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 2px solid var(--gold); }
    
    @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; display: flex; flex-wrap: wrap; } .qr-item { width: 45%; margin: 2%; padding: 10px; border: 2px solid #000; text-align: center; border-radius: 8px; } }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="hero text-center" id="main-header">
  <div class="mb-2"><i class="fa-solid fa-graduation-cap fa-2x" style="color:var(--gold)"></i></div>
  <h2 class="fw-bold m-0">SMA IT AL GHIFARI</h2>
  <small style="color:var(--gold); letter-spacing:2px;">Digital Asset Management</small>
</div>

<div class="container mt-0">

  <!-- === TAMPILAN 1: MENU UTAMA === -->
  <div id="view-home">
    <div class="row g-3 justify-content-center">
      <div class="col-6 col-md-4">
        <div class="glass-card menu-btn" onclick="startScanner()">
          <div class="icon-box"><i class="fa-solid fa-qrcode"></i></div>
          <h6 class="fw-bold">Scan QR</h6>
          <small class="text-muted d-block mt-2">Pindai kode aset</small>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="glass-card menu-btn" onclick="showLogin()">
          <div class="icon-box"><i class="fa-solid fa-user-gear"></i></div>
          <h6 class="fw-bold">Admin</h6>
          <small class="text-muted d-block mt-2">Kelola data</small>
        </div>
      </div>
    </div>
  </div>

  <!-- === TAMPILAN 2: SCANNER MODE (FULL FOCUS) === -->
  <div id="view-scan" class="hidden">
    <!-- Tombol Kembali -->
    <div class="mb-3">
        <button class="btn btn-light text-primary fw-bold shadow-sm rounded-pill px-4" onclick="stopScanner()">
            <i class="fa-solid fa-arrow-left"></i> Kembali ke Menu
        </button>
    </div>

    <!-- Area Kamera -->
    <div id="camera-container">
        <div class="text-center mb-2 text-white">
             <span class="badge bg-dark px-3 py-2 rounded-pill border border-warning">Mode Pindai Aktif</span>
        </div>
        <div id="qr-reader"></div>
        <p class="text-center text-muted mt-2 small">Arahkan kamera ke QR Code Aset</p>
    </div>

    <!-- Hasil Scan -->
    <div id="result-card" class="glass-card hidden mt-3">
        <div class="text-center mb-3"><span class="badge bg-success rounded-pill px-3">Aset Ditemukan</span></div>
        <h3 id="r-nama" class="fw-bold text-center text-primary mb-1"></h3>
        <p id="r-kib" class="text-center text-muted small mb-4"></p>
        <ul class="list-group list-group-flush mb-4 rounded-3 small">
            <li class="list-group-item d-flex justify-content-between"><span class="text-muted">ID</span><span class="fw-bold" id="r-id"></span></li>
            <li class="list-group-item d-flex justify-content-between"><span class="text-muted">Lokasi</span><span class="fw-bold" id="r-lokasi"></span></li>
            <li class="list-group-item d-flex justify-content-between"><span class="text-muted">Kondisi</span><span class="fw-bold text-success" id="r-kondisi"></span></li>
        </ul>
        <h6 class="fw-bold text-danger">Lapor Masalah</h6>
        <input type="text" id="lap-nama" class="form-control mb-2 form-control-sm" placeholder="Nama Pelapor">
        <textarea id="lap-msg" class="form-control mb-3 form-control-sm" rows="2" placeholder="Kerusakan..."></textarea>
        <button class="btn btn-gold w-100 btn-sm" onclick="kirimLaporan()">Kirim Laporan</button>
    </div>
  </div>

  <!-- === TAMPILAN 3: LOGIN === -->
  <div id="view-login" class="hidden row justify-content-center">
    <div class="col-md-5">
        <div class="glass-card p-4">
            <h4 class="fw-bold text-center mb-4">Login Admin</h4>
            <input type="text" id="login-u" class="form-control mb-3" placeholder="Username">
            <input type="password" id="login-p" class="form-control mb-4" placeholder="Password">
            <button class="btn btn-gold w-100 mb-3" onclick="doLogin()">MASUK</button>
            <button class="btn btn-light w-100 text-muted rounded-pill" onclick="showHome()">Batal</button>
        </div>
    </div>
  </div>

  <!-- === TAMPILAN 4: DASHBOARD ADMIN === -->
  <div id="view-admin" class="hidden">
    <div class="d-flex justify-content-between align-items-center mb-4 px-2">
        <div><h5 class="fw-bold m-0">Dashboard</h5><small class="text-muted">Kelola Aset</small></div>
        <button class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="doLogout()">Logout</button>
    </div>

    <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab">
        <li class="nav-item"><a class="nav-link active rounded-pill px-4" data-bs-toggle="pill" href="#tab-data">Data</a></li>
        <li class="nav-item"><a class="nav-link rounded-pill px-4" data-bs-toggle="pill" href="#tab-add">Tambah</a></li>
        <li class="nav-item"><a class="nav-link rounded-pill px-4" data-bs-toggle="pill" href="#tab-print">Print</a></li>
    </ul>

    <div class="glass-card">
        <div class="tab-content">
            <!-- DATA TABLE -->
            <div class="tab-pane fade show active" id="tab-data">
                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-light border" onclick="loadDataBarang()">Refresh</button>
                </div>
                <div class="table-responsive rounded-3 border">
                    <table class="table table-hover mb-0 align-middle small">
                        <thead class="table-light"><tr><th>Aset</th><th>KIB</th><th class="text-center">Jml</th><th class="text-end">Aksi</th></tr></thead>
                        <tbody id="tbody-barang" class="bg-white"></tbody>
                    </table>
                </div>
            </div>

            <!-- ADD FORM -->
            <div class="tab-pane fade" id="tab-add">
                <form onsubmit="event.preventDefault(); simpanBarang();">
                    <div class="mb-2"><label class="small fw-bold">Nama Barang</label><input type="text" id="in-nama" class="form-control" required></div>
                    <div class="row mb-2">
                        <div class="col-6"><label class="small fw-bold">KIB</label>
                            <select id="in-kib" class="form-select">
                                <option value="KIB B (Peralatan)">KIB B (Alat)</option>
                                <option value="KIB A (Tanah)">KIB A (Tanah)</option>
                                <option value="KIB C (Gedung)">KIB C (Gedung)</option>
                                <option value="KIB E (Lainnya)">KIB E (Lain)</option>
                            </select>
                        </div>
                        <div class="col-6"><label class="small fw-bold">Jumlah</label><input type="number" id="in-jumlah" class="form-control" value="1"></div>
                    </div>
                    <div class="mb-2"><label class="small fw-bold">Lokasi</label><input type="text" id="in-loc" class="form-control"></div>
                    <div class="row mb-3">
                        <div class="col-6"><label class="small fw-bold">Sumber</label><input type="text" id="in-sumber" class="form-control"></div>
                        <div class="col-6"><label class="small fw-bold">Harga</label><input type="number" id="in-harga" class="form-control"></div>
                    </div>
                    <button type="submit" class="btn btn-gold w-100">SIMPAN</button>
                </form>
            </div>

            <!-- PRINT -->
            <div class="tab-pane fade" id="tab-print">
                <button class="btn btn-dark w-100 mb-2 rounded-pill" onclick="generateQRLabels()">Generate Label</button>
                <button class="btn btn-outline-dark w-100 rounded-pill" onclick="window.print()">Print PDF</button>
                <div id="print-area" class="mt-3 p-2 bg-light border text-center text-muted small">Preview...</div>
            </div>
        </div>
    </div>
  </div>
</div>

<!-- MODAL EDIT -->
<div class="modal fade" id="modal-edit" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-warning border-0">
        <h5 class="modal-title fw-bold text-dark"><i class="fa-solid fa-pen-to-square"></i> Edit Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form onsubmit="event.preventDefault(); simpanEdit();">
            <input type="hidden" id="edit-id">
            <div class="mb-2"><label class="small fw-bold">Nama Barang</label><input type="text" id="edit-nama" class="form-control" required></div>
            <div class="row mb-2">
                <div class="col-6"><label class="small fw-bold">KIB</label>
                    <select id="edit-kib" class="form-select">
                        <option value="KIB B (Peralatan)">KIB B (Alat)</option>
                        <option value="KIB A (Tanah)">KIB A (Tanah)</option>
                        <option value="KIB C (Gedung)">KIB C (Gedung)</option>
                        <option value="KIB E (Lainnya)">KIB E (Lain)</option>
                    </select>
                </div>
                <div class="col-6"><label class="small fw-bold">Kondisi</label>
                     <select id="edit-kondisi" class="form-select">
                        <option value="Baik">Baik</option>
                        <option value="Rusak Ringan">Rusak Ringan</option>
                        <option value="Rusak Berat">Rusak Berat</option>
                    </select>
                </div>
            </div>
            <div class="mb-2"><label class="small fw-bold">Lokasi</label><input type="text" id="edit-loc" class="form-control"></div>
            <div class="row mb-2">
                 <div class="col-6"><label class="small fw-bold">Jumlah</label><input type="number" id="edit-jumlah" class="form-control"></div>
                 <div class="col-6"><label class="small fw-bold">Harga</label><input type="number" id="edit-harga" class="form-control"></div>
            </div>
            <div class="mb-3"><label class="small fw-bold">Sumber</label><input type="text" id="edit-sumber" class="form-control"></div>
            <button type="submit" class="btn btn-gold w-100">UPDATE DATA</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// --- NAVIGATION UTILS ---
function hideAll() { 
    ['view-home', 'view-login', 'view-admin', 'view-scan'].forEach(id => document.getElementById(id).classList.add('hidden')); 
}

function showHome() { 
    hideAll(); 
    document.getElementById('view-home').classList.remove('hidden'); 
    document.getElementById('main-header').classList.remove('hidden'); // Tampilkan Header
}

function showLogin() { 
    hideAll(); 
    document.getElementById('view-login').classList.remove('hidden'); 
}

function showAdmin() { 
    hideAll(); 
    document.getElementById('view-admin').classList.remove('hidden'); 
    loadDataBarang(); 
}

// --- SCANNER LOGIC (UPDATED) ---
let html5QrcodeScanner;

function startScanner() {
    hideAll(); // Sembunyikan semua termasuk Home
    document.getElementById('view-scan').classList.remove('hidden'); // Tampilkan View Scan
    document.getElementById('main-header').classList.add('hidden'); // Sembunyikan Header agar luas
    document.getElementById('camera-container').classList.remove('hidden');
    document.getElementById('result-card').classList.add('hidden'); // Sembunyikan hasil scan lama

    html5QrcodeScanner = new Html5Qrcode("qr-reader");
    html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
}

function stopScanner() {
    if(html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
            html5QrcodeScanner.clear();
            showHome(); // KEMBALI KE MENU UTAMA
        }).catch(() => showHome());
    } else {
        showHome();
    }
}

function onScanSuccess(decodedText) {
    // Stop scanning tapi TETAP di halaman view-scan
    if(html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
            html5QrcodeScanner.clear();
            document.getElementById('camera-container').classList.add('hidden'); // Sembunyikan kamera
        });
    }

    google.script.run.withSuccessHandler(item => {
        if(item) {
            document.getElementById('result-card').classList.remove('hidden'); // Tampilkan Hasil
            document.getElementById('r-nama').innerText = item['Nama Barang'];
            document.getElementById('r-id').innerText = item.ID;
            document.getElementById('r-lokasi').innerText = item.Lokasi;
            document.getElementById('r-kondisi').innerText = item.Kondisi;
            document.getElementById('r-kib').innerText = item.KIB;
        } else {
            Swal.fire('Maaf', 'Aset tidak ditemukan dalam database', 'error').then(() => {
                startScanner(); // Mulai scan lagi jika salah
            });
        }
    }).getDetailBarang(decodedText);
}

// --- LOGIN & LOGOUT ---
function doLogout() {
    Swal.fire({
        title: 'Logout?', text: "Anda akan keluar dari panel admin.", icon: 'warning',
        showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, Logout', cancelButtonText: 'Batal'
    }).then((result) => { if (result.isConfirmed) showHome(); });
}

function doLogin() {
    const u = document.getElementById('login-u').value, p = document.getElementById('login-p').value;
    const btn = document.querySelector('button[onclick="doLogin()"]'); btn.innerHTML='Loading...'; btn.disabled=true;
    google.script.run.withSuccessHandler(isValid => {
        btn.innerHTML='MASUK'; btn.disabled=false;
        if(isValid) {
            document.getElementById('login-p').value='';
            Swal.fire({icon: 'success', title: 'Login Sukses', timer: 1500, showConfirmButton: false}).then(() => showAdmin());
        } else Swal.fire('Gagal', 'Username/Password salah!', 'error');
    }).loginAdmin(u, p);
}

// --- DATA CRUD ---
let globalData = [];
function loadDataBarang() {
    const tbody = document.getElementById('tbody-barang');
    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Loading...</td></tr>';
    google.script.run.withSuccessHandler(data => {
        globalData = data; tbody.innerHTML = '';
        if(!data || data.length===0) return tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Data Kosong</td></tr>';
        data.forEach(item => {
            let nama = item['Nama Barang']||'?', id = item['ID']||'?', kib = item['KIB']||'-', jml = item['Jumlah Barang']||0;
            tbody.innerHTML += `
            <tr>
                <td><div class="fw-bold text-dark">${nama}</div><div class="small text-muted font-monospace">${id}</div></td>
                <td><span class="badge bg-light text-dark border">${kib.split(' ')[0]} ${kib.split(' ')[1]||''}</span></td>
                <td class="text-center fw-bold">${jml}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-light text-warning border me-1" onclick="openEditModal('${id}')"><i class="fa-solid fa-pen-to-square"></i></button>
                    <button class="btn btn-sm btn-light text-danger border" onclick="hapus('${id}')"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }).getBarang();
}

function openEditModal(id) {
    const item = globalData.find(i => i.ID == id);
    if(!item) return;
    document.getElementById('edit-id').value = item.ID;
    document.getElementById('edit-nama').value = item['Nama Barang'];
    document.getElementById('edit-kib').value = item.KIB;
    document.getElementById('edit-loc').value = item.Lokasi;
    document.getElementById('edit-kondisi').value = item.Kondisi;
    document.getElementById('edit-jumlah').value = item['Jumlah Barang'];
    document.getElementById('edit-harga').value = item['Harga Satuan'];
    document.getElementById('edit-sumber').value = item.Sumber;
    new bootstrap.Modal(document.getElementById('modal-edit')).show();
}

function simpanEdit() {
    const btn = document.querySelector('#modal-edit button[type="submit"]'); btn.innerHTML = 'Updating...'; btn.disabled = true;
    const form = {
        id: document.getElementById('edit-id').value, nama: document.getElementById('edit-nama').value,
        kib: document.getElementById('edit-kib').value, lokasi: document.getElementById('edit-loc').value,
        kondisi: document.getElementById('edit-kondisi').value, jumlah: document.getElementById('edit-jumlah').value,
        harga: document.getElementById('edit-harga').value, sumber: document.getElementById('edit-sumber').value
    };
    google.script.run.withSuccessHandler(res => {
        bootstrap.Modal.getInstance(document.getElementById('modal-edit')).hide();
        btn.innerHTML = 'UPDATE DATA'; btn.disabled = false;
        Swal.fire({icon: 'success', title: 'Berhasil!', text: res, confirmButtonColor: '#d4af37'}).then(() => loadDataBarang());
    }).editBarang(form);
}

function simpanBarang() {
    const btn = document.querySelector('#tab-add button[type="submit"]'); btn.innerHTML='Menyimpan...'; btn.disabled=true;
    const form = {
        nama: document.getElementById('in-nama').value, kib: document.getElementById('in-kib').value,
        lokasi: document.getElementById('in-loc').value, jumlah: document.getElementById('in-jumlah').value,
        sumber: document.getElementById('in-sumber').value, harga: document.getElementById('in-harga').value
    };
    google.script.run.withSuccessHandler(res => {
        document.querySelector('#tab-add form').reset();
        bootstrap.Tab.getInstance(document.querySelector('a[href="#tab-data"]')).show();
        loadDataBarang();
        btn.innerHTML='SIMPAN'; btn.disabled=false;
        Swal.fire({icon: 'success', title: 'Tersimpan!', text: res, confirmButtonColor: '#d4af37'});
    }).tambahBarang(form);
}

function hapus(id) {
    Swal.fire({
        title: 'Hapus aset?', text: "ID: " + id, icon: 'warning',
        showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Hapus'
    }).then((result) => {
        if (result.isConfirmed) google.script.run.withSuccessHandler(res => { Swal.fire('Terhapus!', res, 'success'); loadDataBarang(); }).hapusBarang(id);
    });
}

function generateQRLabels() {
    const area = document.getElementById('print-area'); area.innerHTML='';
    if(globalData.length===0) return Swal.fire('Info', 'Data kosong', 'info');
    globalData.forEach(item => {
        const d = document.createElement('div'); d.className='qr-item';
        d.innerHTML = `<b>SMA IT AL GHIFARI</b><br><small>${item.KIB}</small><div id="qr-${item.ID}" style="display:flex;justify-content:center;margin:5px;"></div><b>${item['Nama Barang']}</b><br><small>${item.ID}</small>`;
        area.appendChild(d);
        new QRCode(document.getElementById(`qr-${item.ID}`),{text:item.ID,width:70,height:70});
    });
}

function kirimLaporan(){
    const id=document.getElementById('r-id').innerText, n=document.getElementById('lap-nama').value, m=document.getElementById('lap-msg').value;
    if(n&&m) google.script.run.withSuccessHandler(res=>{
        Swal.fire('Terkirim!', res, 'success').then(() => showHome());
    }).laporMasalah(id,m,n);
    else Swal.fire('Error', 'Lengkapi data laporan', 'warning');
}
</script>
</body>
</html>
